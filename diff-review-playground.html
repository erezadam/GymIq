<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diff Review Playground</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface-2: #1c2128;
    --border: #30363d;
    --border-focus: #58a6ff;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --text-dim: #484f58;
    --add-bg: #12261e;
    --add-border: #196c2e;
    --add-text: #3fb950;
    --add-line-bg: rgba(63, 185, 80, 0.15);
    --del-bg: #2a1215;
    --del-border: #8b1a1a;
    --del-text: #f85149;
    --del-line-bg: rgba(248, 81, 73, 0.1);
    --hunk-bg: #1a2332;
    --hunk-text: #58a6ff;
    --accent: #58a6ff;
    --accent-green: #3fb950;
    --accent-red: #f85149;
    --accent-yellow: #d29922;
    --accent-purple: #bc8cff;
    --comment-bg: #1c2128;
    --comment-border: #d29922;
    --scrollbar-track: #161b22;
    --scrollbar-thumb: #30363d;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
  ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #484f58; }

  /* Header */
  .header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo {
    font-size: 20px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  /* Buttons */
  .btn {
    padding: 6px 14px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    font-size: 13px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .btn:hover { border-color: var(--text-muted); background: var(--surface); }
  .btn.active { border-color: var(--accent); color: var(--accent); background: rgba(88, 166, 255, 0.1); }

  .btn-approve {
    background: rgba(63, 185, 80, 0.15);
    border-color: var(--add-border);
    color: var(--accent-green);
  }
  .btn-approve:hover { background: rgba(63, 185, 80, 0.25); }
  .btn-approve.active { background: rgba(63, 185, 80, 0.3); border-color: var(--accent-green); }

  .btn-reject {
    background: rgba(248, 81, 73, 0.1);
    border-color: var(--del-border);
    color: var(--accent-red);
  }
  .btn-reject:hover { background: rgba(248, 81, 73, 0.2); }
  .btn-reject.active { background: rgba(248, 81, 73, 0.25); border-color: var(--accent-red); }

  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #0d1117;
    font-weight: 600;
  }
  .btn-primary:hover { opacity: 0.9; }

  /* Layout */
  .main {
    display: flex;
    height: calc(100vh - 57px);
  }

  /* Sidebar */
  .sidebar {
    width: 300px;
    min-width: 300px;
    border-right: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-section h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .file-list {
    list-style: none;
    overflow-y: auto;
    flex: 1;
    padding: 8px;
  }

  .file-item {
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    transition: background 0.1s;
    position: relative;
  }

  .file-item:hover { background: var(--surface-2); }
  .file-item.active { background: rgba(88, 166, 255, 0.1); color: var(--accent); }

  .file-item .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .file-item .status-dot.added { background: var(--accent-green); }
  .file-item .status-dot.deleted { background: var(--accent-red); }
  .file-item .status-dot.modified { background: var(--accent-yellow); }
  .file-item .status-dot.renamed { background: var(--accent-purple); }

  .file-item .file-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .file-item .file-stats {
    font-size: 11px;
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .file-item .file-stats .add { color: var(--accent-green); }
  .file-item .file-stats .del { color: var(--accent-red); }

  .file-item .review-badge {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .review-badge.approved { background: rgba(63,185,80,0.2); color: var(--accent-green); }
  .review-badge.rejected { background: rgba(248,81,73,0.15); color: var(--accent-red); }
  .review-badge.commented { background: rgba(210,153,34,0.2); color: var(--accent-yellow); }

  /* Diff Content */
  .diff-content {
    flex: 1;
    overflow: auto;
    display: flex;
    flex-direction: column;
  }

  /* Input area */
  .input-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
  }

  .input-area.hidden { display: none; }

  .input-box {
    width: 100%;
    max-width: 700px;
  }

  .input-box h2 {
    font-size: 22px;
    margin-bottom: 6px;
  }

  .input-box p {
    color: var(--text-muted);
    margin-bottom: 20px;
    font-size: 14px;
  }

  .input-box textarea {
    width: 100%;
    height: 300px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 12px;
    padding: 16px;
    resize: vertical;
    outline: none;
    transition: border-color 0.15s;
  }

  .input-box textarea:focus { border-color: var(--accent); }
  .input-box textarea::placeholder { color: var(--text-dim); }

  .input-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    justify-content: flex-end;
  }

  /* Diff view */
  .diff-view { display: none; flex-direction: column; flex: 1; overflow: hidden; }
  .diff-view.visible { display: flex; }

  .diff-toolbar {
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
    flex-shrink: 0;
  }

  .diff-toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .file-path {
    font-family: 'SF Mono', monospace;
    font-size: 13px;
    color: var(--text);
  }

  .file-type-badge {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
  }

  .file-type-badge.A { background: rgba(63,185,80,0.15); color: var(--accent-green); }
  .file-type-badge.D { background: rgba(248,81,73,0.1); color: var(--accent-red); }
  .file-type-badge.M { background: rgba(210,153,34,0.15); color: var(--accent-yellow); }
  .file-type-badge.R { background: rgba(188,140,255,0.15); color: var(--accent-purple); }

  .view-toggle {
    display: flex;
    background: var(--bg);
    border-radius: 6px;
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .view-toggle button {
    padding: 5px 12px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
  }

  .view-toggle button.active {
    background: var(--surface-2);
    color: var(--text);
  }

  .view-toggle button:hover:not(.active) { color: var(--text); }

  /* Diff table */
  .diff-scroll {
    flex: 1;
    overflow: auto;
  }

  .diff-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 12px;
    line-height: 20px;
    table-layout: fixed;
  }

  .diff-table td {
    padding: 0 12px;
    vertical-align: top;
    white-space: pre;
    overflow: hidden;
  }

  .diff-table .line-num {
    width: 50px;
    min-width: 50px;
    text-align: right;
    color: var(--text-dim);
    user-select: none;
    padding-right: 10px;
    cursor: pointer;
    position: relative;
  }

  .diff-table .line-num:hover { color: var(--accent); }

  .diff-table .line-prefix {
    width: 20px;
    min-width: 20px;
    text-align: center;
    user-select: none;
  }

  .diff-table .line-content {
    width: auto;
  }

  /* Line types */
  .diff-line-add { background: var(--add-line-bg); }
  .diff-line-add .line-num { background: rgba(63, 185, 80, 0.1); }
  .diff-line-add .line-prefix { color: var(--accent-green); }

  .diff-line-del { background: var(--del-line-bg); }
  .diff-line-del .line-num { background: rgba(248, 81, 73, 0.07); }
  .diff-line-del .line-prefix { color: var(--accent-red); }

  .diff-line-hunk {
    background: var(--hunk-bg);
    color: var(--hunk-text);
  }
  .diff-line-hunk td { padding-top: 6px; padding-bottom: 6px; }
  .diff-line-hunk .line-num { background: rgba(88, 166, 255, 0.05); }

  .diff-line-ctx { background: transparent; }
  .diff-line-ctx .line-prefix { color: var(--text-dim); }

  /* Inline highlight for changed words */
  .word-add {
    background: rgba(63, 185, 80, 0.3);
    border-radius: 2px;
    padding: 0 1px;
  }

  .word-del {
    background: rgba(248, 81, 73, 0.3);
    border-radius: 2px;
    padding: 0 1px;
  }

  /* Side by side */
  .diff-table.side-by-side .line-num { width: 45px; min-width: 45px; }
  .diff-table.side-by-side .side-left { border-right: 1px solid var(--border); }

  /* Comment rows */
  .comment-row td {
    padding: 0 !important;
    background: var(--bg);
  }

  .comment-box {
    margin: 4px 12px 4px 72px;
    border: 1px solid var(--comment-border);
    border-radius: 8px;
    background: var(--comment-bg);
    overflow: hidden;
  }

  .comment-box-header {
    padding: 8px 12px;
    background: rgba(210, 153, 34, 0.1);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
    color: var(--accent-yellow);
  }

  .comment-box-body {
    padding: 10px 12px;
  }

  .comment-box textarea {
    width: 100%;
    min-height: 60px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    padding: 8px 10px;
    resize: vertical;
    outline: none;
  }

  .comment-box textarea:focus { border-color: var(--accent); }

  .comment-box-actions {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    margin-top: 8px;
  }

  .comment-saved {
    padding: 10px 12px;
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: inherit;
  }

  .comment-indicator {
    position: absolute;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent-yellow);
  }

  /* Stats bar */
  .stats-bar {
    padding: 8px 20px;
    border-top: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: var(--text-muted);
    flex-shrink: 0;
  }

  .stats-bar .stat { display: flex; align-items: center; gap: 4px; }
  .stats-bar .stat.green { color: var(--accent-green); }
  .stats-bar .stat.red { color: var(--accent-red); }

  /* Review summary panel */
  .review-panel {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 200;
    overflow: hidden;
  }

  .review-panel.visible { display: block; }

  .review-panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .review-panel-header h3 { font-size: 14px; }

  .review-panel-body {
    padding: 16px;
    max-height: 400px;
    overflow-y: auto;
  }

  .review-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }

  .review-item:last-child { border-bottom: none; }

  .review-item .ri-file {
    font-family: 'SF Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .review-item .ri-line {
    font-size: 11px;
    color: var(--text-dim);
  }

  .review-item .ri-comment {
    margin-top: 4px;
    color: var(--text-muted);
    font-size: 12px;
    white-space: pre-wrap;
  }

  .review-panel-footer {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
  }

  .review-panel-footer .btn { flex: 1; justify-content: center; }

  /* Copy toast */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--accent-green);
    color: #0d1117;
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 999;
  }

  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Keyboard shortcuts overlay */
  .shortcuts-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 500;
    align-items: center;
    justify-content: center;
  }

  .shortcuts-overlay.visible { display: flex; }

  .shortcuts-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    width: 420px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .shortcuts-box h3 { margin-bottom: 16px; font-size: 16px; }

  .shortcut-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-size: 13px;
  }

  .shortcut-row kbd {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'SF Mono', monospace;
    font-size: 11px;
  }

  /* Summary textarea */
  .summary-textarea {
    width: 100%;
    min-height: 80px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    padding: 10px;
    resize: vertical;
    outline: none;
    margin-top: 12px;
  }

  .summary-textarea:focus { border-color: var(--accent); }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="logo">Diff Review</span>
    <span class="badge">Playground</span>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="showShortcuts()" title="Keyboard shortcuts">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M1.5 3A1.5 1.5 0 003 4.5h10A1.5 1.5 0 0014.5 3h-13zm0 1A.5.5 0 011 3.5V3a.5.5 0 01.5-.5h13a.5.5 0 01.5.5v.5a.5.5 0 01-.5.5h-13zM0 5.5A1.5 1.5 0 011.5 4h13A1.5 1.5 0 0116 5.5v5a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 010 10.5v-5zM1.5 5a.5.5 0 00-.5.5v5a.5.5 0 00.5.5h13a.5.5 0 00.5-.5v-5a.5.5 0 00-.5-.5h-13z"/><path d="M3 7.5a.5.5 0 01.5-.5h1a.5.5 0 010 1h-1a.5.5 0 01-.5-.5zm3 0a.5.5 0 01.5-.5h1a.5.5 0 010 1h-1A.5.5 0 016 7.5zm3 0a.5.5 0 01.5-.5h1a.5.5 0 010 1h-1a.5.5 0 01-.5-.5zm3 0a.5.5 0 01.5-.5h.5a.5.5 0 010 1H13a.5.5 0 01-.5-.5zM3 9.5a.5.5 0 01.5-.5h7a.5.5 0 010 1h-7a.5.5 0 01-.5-.5z"/></svg>
      Keys
    </button>
    <button class="btn" id="reviewSummaryBtn" onclick="toggleReviewPanel()" style="display:none">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>
      Review Summary
    </button>
    <button class="btn" id="resetBtn" onclick="resetAll()" style="display:none">Reset</button>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar" style="display:none">
    <div class="sidebar-section">
      <h3>Files changed</h3>
      <div style="display:flex;gap:8px;font-size:12px;">
        <span id="statsFiles" style="color:var(--text)">0 files</span>
        <span id="statsAdded" style="color:var(--accent-green)">+0</span>
        <span id="statsDeleted" style="color:var(--accent-red)">-0</span>
      </div>
    </div>
    <ul class="file-list" id="fileList"></ul>
  </div>

  <div class="diff-content">
    <div class="input-area" id="inputArea">
      <div class="input-box">
        <h2>Paste a diff to review</h2>
        <p>Paste the output of <code style="background:var(--surface-2);padding:2px 6px;border-radius:4px;font-size:12px;">git diff</code>, a PR diff, or any unified diff format.</p>
        <textarea id="diffInput" placeholder="diff --git a/src/app.ts b/src/app.ts
index 1234567..abcdefg 100644
--- a/src/app.ts
+++ b/src/app.ts
@@ -10,6 +10,8 @@ function main() {
   const app = express();
+  app.use(cors());
+  app.use(helmet());
   app.listen(3000);
 }"></textarea>
        <div class="input-actions">
          <button class="btn" onclick="loadSample()">Load Sample</button>
          <button class="btn btn-primary" onclick="parseDiff()">Review Diff</button>
        </div>
      </div>
    </div>

    <div class="diff-view" id="diffView">
      <div class="diff-toolbar">
        <div class="diff-toolbar-left">
          <span class="file-path" id="currentFilePath">-</span>
          <span class="file-type-badge" id="currentFileType">M</span>
          <span style="font-size:12px;color:var(--text-muted)" id="currentFileStats"></span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="view-toggle">
            <button class="active" onclick="setViewMode('unified', this)">Unified</button>
            <button onclick="setViewMode('split', this)">Split</button>
          </div>
          <button class="btn btn-approve" id="approveFileBtn" onclick="reviewFile('approved')">Approve</button>
          <button class="btn btn-reject" id="rejectFileBtn" onclick="reviewFile('rejected')">Request Changes</button>
        </div>
      </div>
      <div class="diff-scroll" id="diffScroll">
        <table class="diff-table" id="diffTable"><tbody id="diffBody"></tbody></table>
      </div>
      <div class="stats-bar" id="statsBar">
        <span class="stat green" id="lineAdded">+0</span>
        <span class="stat red" id="lineDeleted">-0</span>
        <span class="stat" id="fileNav">File 1 of 1</span>
        <span style="flex:1"></span>
        <span class="stat" style="color:var(--text-dim)">Click a line number to comment</span>
      </div>
    </div>
  </div>
</div>

<!-- Review panel -->
<div class="review-panel" id="reviewPanel">
  <div class="review-panel-header">
    <h3>Review Summary</h3>
    <button class="btn" style="padding:4px 8px;font-size:11px;" onclick="toggleReviewPanel()">Close</button>
  </div>
  <div class="review-panel-body" id="reviewPanelBody">
    <p style="color:var(--text-muted);font-size:13px;">No comments yet. Click line numbers to add review comments.</p>
  </div>
  <div>
    <div style="padding:0 16px">
      <textarea class="summary-textarea" id="summaryText" placeholder="Overall review summary (optional)..."></textarea>
    </div>
    <div class="review-panel-footer">
      <button class="btn btn-approve" onclick="copyReview('approve')">Copy as Approve</button>
      <button class="btn btn-reject" onclick="copyReview('changes')">Copy as Request Changes</button>
    </div>
  </div>
</div>

<!-- Shortcuts overlay -->
<div class="shortcuts-overlay" id="shortcutsOverlay" onclick="if(event.target===this)hideShortcuts()">
  <div class="shortcuts-box">
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcut-row"><span>Next file</span><kbd>j</kbd> or <kbd>]</kbd></div>
    <div class="shortcut-row"><span>Previous file</span><kbd>k</kbd> or <kbd>[</kbd></div>
    <div class="shortcut-row"><span>Approve file</span><kbd>a</kbd></div>
    <div class="shortcut-row"><span>Request changes</span><kbd>x</kbd></div>
    <div class="shortcut-row"><span>Toggle view mode</span><kbd>v</kbd></div>
    <div class="shortcut-row"><span>Toggle review panel</span><kbd>r</kbd></div>
    <div class="shortcut-row"><span>Show shortcuts</span><kbd>?</kbd></div>
    <div class="shortcut-row"><span>Reset / new diff</span><kbd>Escape</kbd></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  // ─── State ───
  let files = [];
  let currentFileIdx = 0;
  let viewMode = 'unified'; // unified | split
  let comments = {}; // { "filename:lineNum": "comment text" }
  let fileReviews = {}; // { "filename": "approved" | "rejected" }

  // ─── Parse Diff ───
  function parseDiff() {
    const raw = document.getElementById('diffInput').value.trim();
    if (!raw) return;
    files = parseDiffText(raw);
    if (files.length === 0) {
      showToast('No valid diff found');
      return;
    }
    comments = {};
    fileReviews = {};
    document.getElementById('inputArea').classList.add('hidden');
    document.getElementById('diffView').classList.add('visible');
    document.getElementById('sidebar').style.display = 'flex';
    document.getElementById('resetBtn').style.display = '';
    document.getElementById('reviewSummaryBtn').style.display = '';
    renderFileList();
    selectFile(0);
  }

  function parseDiffText(text) {
    const result = [];
    const fileChunks = text.split(/^diff --git /m).filter(Boolean);

    for (const chunk of fileChunks) {
      const lines = chunk.split('\n');
      const headerMatch = lines[0].match(/a\/(.+?) b\/(.+)/);
      if (!headerMatch) continue;

      const fileA = headerMatch[1];
      const fileB = headerMatch[2];
      let status = 'M';
      let hunks = [];
      let additions = 0;
      let deletions = 0;
      let diffLines = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (line.startsWith('new file')) status = 'A';
        else if (line.startsWith('deleted file')) status = 'D';
        else if (line.startsWith('rename from')) status = 'R';
        else if (line.startsWith('@@')) {
          const hunkMatch = line.match(/@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@(.*)/);
          if (hunkMatch) {
            hunks.push({
              oldStart: parseInt(hunkMatch[1]),
              newStart: parseInt(hunkMatch[2]),
              header: line
            });
          }
          diffLines.push({ type: 'hunk', text: line });
        } else if (line.startsWith('+') && !line.startsWith('+++')) {
          diffLines.push({ type: 'add', text: line.substring(1) });
          additions++;
        } else if (line.startsWith('-') && !line.startsWith('---')) {
          diffLines.push({ type: 'del', text: line.substring(1) });
          deletions++;
        } else if (line.startsWith(' ')) {
          diffLines.push({ type: 'ctx', text: line.substring(1) });
        } else if (line.startsWith('\\')) {
          diffLines.push({ type: 'ctx', text: line });
        }
      }

      result.push({
        name: fileB,
        oldName: fileA,
        status,
        additions,
        deletions,
        hunks,
        lines: diffLines
      });
    }

    return result;
  }

  // ─── Render File List ───
  function renderFileList() {
    const list = document.getElementById('fileList');
    let totalAdd = 0, totalDel = 0;
    list.innerHTML = '';
    files.forEach((f, i) => {
      totalAdd += f.additions;
      totalDel += f.deletions;
      const li = document.createElement('li');
      li.className = 'file-item' + (i === currentFileIdx ? ' active' : '');
      li.onclick = () => selectFile(i);

      const statusClass = { A: 'added', D: 'deleted', M: 'modified', R: 'renamed' }[f.status] || 'modified';
      let reviewBadge = '';
      if (fileReviews[f.name]) {
        reviewBadge = `<span class="review-badge ${fileReviews[f.name]}">${fileReviews[f.name] === 'approved' ? '✓' : '✗'}</span>`;
      }

      const commentCount = Object.keys(comments).filter(k => k.startsWith(f.name + ':')).length;
      if (commentCount > 0 && !reviewBadge) {
        reviewBadge = `<span class="review-badge commented">${commentCount}</span>`;
      }

      li.innerHTML = `
        <span class="status-dot ${statusClass}"></span>
        <span class="file-name" title="${f.name}">${shortName(f.name)}</span>
        <span class="file-stats"><span class="add">+${f.additions}</span><span class="del">-${f.deletions}</span></span>
        ${reviewBadge}
      `;
      list.appendChild(li);
    });

    document.getElementById('statsFiles').textContent = files.length + ' file' + (files.length !== 1 ? 's' : '');
    document.getElementById('statsAdded').textContent = '+' + totalAdd;
    document.getElementById('statsDeleted').textContent = '-' + totalDel;
  }

  function shortName(path) {
    const parts = path.split('/');
    if (parts.length <= 2) return path;
    return '.../' + parts.slice(-2).join('/');
  }

  // ─── Select File ───
  function selectFile(idx) {
    currentFileIdx = idx;
    const f = files[idx];
    document.getElementById('currentFilePath').textContent = f.name;
    document.getElementById('currentFileType').textContent = f.status;
    document.getElementById('currentFileType').className = 'file-type-badge ' + f.status;
    document.getElementById('currentFileStats').textContent = `+${f.additions} -${f.deletions}`;
    document.getElementById('lineAdded').textContent = '+' + f.additions;
    document.getElementById('lineDeleted').textContent = '-' + f.deletions;
    document.getElementById('fileNav').textContent = `File ${idx + 1} of ${files.length}`;

    // Update review buttons
    const review = fileReviews[f.name];
    document.getElementById('approveFileBtn').classList.toggle('active', review === 'approved');
    document.getElementById('rejectFileBtn').classList.toggle('active', review === 'rejected');

    renderDiff(f);
    renderFileList();
    document.getElementById('diffScroll').scrollTop = 0;
  }

  // ─── Render Diff ───
  function renderDiff(file) {
    const tbody = document.getElementById('diffBody');
    const table = document.getElementById('diffTable');
    tbody.innerHTML = '';

    if (viewMode === 'split') {
      table.classList.add('side-by-side');
      renderSplitDiff(file, tbody);
    } else {
      table.classList.remove('side-by-side');
      renderUnifiedDiff(file, tbody);
    }
  }

  function renderUnifiedDiff(file, tbody) {
    let oldLine = 0, newLine = 0;

    for (const dl of file.lines) {
      if (dl.type === 'hunk') {
        const m = dl.text.match(/@@ -(\d+)(?:,\d+)? \+(\d+)/);
        if (m) { oldLine = parseInt(m[1]); newLine = parseInt(m[2]); }
        const tr = document.createElement('tr');
        tr.className = 'diff-line-hunk';
        tr.innerHTML = `<td class="line-num"></td><td class="line-num"></td><td class="line-prefix"></td><td class="line-content" colspan="1">${escapeHtml(dl.text)}</td>`;
        tbody.appendChild(tr);
        continue;
      }

      const lineClass = { add: 'diff-line-add', del: 'diff-line-del', ctx: 'diff-line-ctx' }[dl.type];
      const prefix = { add: '+', del: '-', ctx: ' ' }[dl.type];
      const oldNum = dl.type === 'add' ? '' : oldLine;
      const newNum = dl.type === 'del' ? '' : newLine;
      const lineKey = dl.type !== 'del' ? newLine : 'old-' + oldLine;

      const tr = document.createElement('tr');
      tr.className = lineClass;
      tr.innerHTML = `
        <td class="line-num" data-line="${lineKey}" onclick="toggleComment('${file.name}', ${lineKey})">${oldNum}${hasComment(file.name, lineKey) ? '<span class="comment-indicator"></span>' : ''}</td>
        <td class="line-num" data-line="${lineKey}" onclick="toggleComment('${file.name}', ${lineKey})">${newNum}${hasComment(file.name, lineKey) ? '<span class="comment-indicator"></span>' : ''}</td>
        <td class="line-prefix">${prefix}</td>
        <td class="line-content">${escapeHtml(dl.text)}</td>
      `;
      tbody.appendChild(tr);

      // Render existing comment
      if (hasComment(file.name, lineKey)) {
        renderCommentRow(tbody, file.name, lineKey);
      }

      if (dl.type === 'del') oldLine++;
      else if (dl.type === 'add') newLine++;
      else { oldLine++; newLine++; }
    }
  }

  function renderSplitDiff(file, tbody) {
    let oldLine = 0, newLine = 0;
    const pairs = [];
    let delBuffer = [], addBuffer = [];

    function flushBuffers() {
      const max = Math.max(delBuffer.length, addBuffer.length);
      for (let i = 0; i < max; i++) {
        pairs.push({
          left: delBuffer[i] || null,
          right: addBuffer[i] || null,
          leftNum: delBuffer[i] ? delBuffer[i].lineNum : '',
          rightNum: addBuffer[i] ? addBuffer[i].lineNum : ''
        });
      }
      delBuffer = [];
      addBuffer = [];
    }

    for (const dl of file.lines) {
      if (dl.type === 'hunk') {
        flushBuffers();
        const m = dl.text.match(/@@ -(\d+)(?:,\d+)? \+(\d+)/);
        if (m) { oldLine = parseInt(m[1]); newLine = parseInt(m[2]); }
        pairs.push({ type: 'hunk', text: dl.text });
        continue;
      }

      if (dl.type === 'del') {
        if (addBuffer.length > 0) flushBuffers();
        delBuffer.push({ ...dl, lineNum: oldLine++ });
      } else if (dl.type === 'add') {
        addBuffer.push({ ...dl, lineNum: newLine++ });
      } else {
        flushBuffers();
        pairs.push({
          left: dl, right: dl,
          leftNum: oldLine++, rightNum: newLine++
        });
      }
    }
    flushBuffers();

    for (const p of pairs) {
      const tr = document.createElement('tr');
      if (p.type === 'hunk') {
        tr.className = 'diff-line-hunk';
        tr.innerHTML = `<td class="line-num" colspan="2"></td><td class="line-content side-left" colspan="1">${escapeHtml(p.text)}</td><td class="line-num" colspan="2"></td><td class="line-content" colspan="1">${escapeHtml(p.text)}</td>`;
      } else {
        const leftClass = p.left ? (p.left.type === 'del' ? 'diff-line-del' : 'diff-line-ctx') : '';
        const rightClass = p.right ? (p.right.type === 'add' ? 'diff-line-add' : 'diff-line-ctx') : '';
        tr.innerHTML = `
          <td class="line-num ${leftClass}" onclick="toggleComment('${file.name}', ${p.leftNum || 0})">${p.leftNum}</td>
          <td class="line-content side-left ${leftClass}">${p.left ? escapeHtml(p.left.text) : ''}</td>
          <td class="line-num ${rightClass}" onclick="toggleComment('${file.name}', ${p.rightNum || 0})">${p.rightNum}</td>
          <td class="line-content ${rightClass}">${p.right ? escapeHtml(p.right.text) : ''}</td>
        `;
      }
      tbody.appendChild(tr);
    }
  }

  // ─── Comments ───
  function hasComment(filename, lineKey) {
    return comments[filename + ':' + lineKey] !== undefined;
  }

  function toggleComment(filename, lineKey) {
    if (typeof lineKey === 'string' && lineKey.startsWith('old-')) return; // skip for delete-only lines
    const key = filename + ':' + lineKey;

    // If comment already exists and saved, re-render to edit
    const f = files[currentFileIdx];
    renderDiff(f);

    if (!comments[key]) {
      // Add new comment input
      const rows = document.getElementById('diffBody').rows;
      for (let i = 0; i < rows.length; i++) {
        const td = rows[i].querySelector(`td[data-line="${lineKey}"]`);
        if (td) {
          const commentTr = document.createElement('tr');
          commentTr.className = 'comment-row';
          commentTr.innerHTML = `<td colspan="4">
            <div class="comment-box">
              <div class="comment-box-header"><span>Line ${lineKey}</span></div>
              <div class="comment-box-body">
                <textarea id="comment-input-${lineKey}" placeholder="Write a review comment..." autofocus></textarea>
                <div class="comment-box-actions">
                  <button class="btn" style="font-size:11px;padding:4px 10px;" onclick="cancelComment('${filename}', ${lineKey})">Cancel</button>
                  <button class="btn btn-primary" style="font-size:11px;padding:4px 10px;" onclick="saveComment('${filename}', ${lineKey})">Save</button>
                </div>
              </div>
            </div>
          </td>`;
          rows[i].after(commentTr);
          setTimeout(() => commentTr.querySelector('textarea').focus(), 50);
          break;
        }
      }
    }
  }

  function renderCommentRow(tbody, filename, lineKey) {
    const key = filename + ':' + lineKey;
    const text = comments[key];
    const tr = document.createElement('tr');
    tr.className = 'comment-row';
    tr.innerHTML = `<td colspan="4">
      <div class="comment-box">
        <div class="comment-box-header">
          <span>Line ${lineKey}</span>
          <span>
            <button class="btn" style="font-size:10px;padding:2px 6px;" onclick="editComment('${filename}', ${lineKey})">Edit</button>
            <button class="btn" style="font-size:10px;padding:2px 6px;color:var(--accent-red);border-color:var(--del-border);" onclick="deleteComment('${filename}', ${lineKey})">Delete</button>
          </span>
        </div>
        <div class="comment-saved">${escapeHtml(text)}</div>
      </div>
    </td>`;
    tbody.appendChild(tr);
  }

  function saveComment(filename, lineKey) {
    const input = document.getElementById('comment-input-' + lineKey);
    if (!input || !input.value.trim()) return;
    comments[filename + ':' + lineKey] = input.value.trim();
    renderDiff(files[currentFileIdx]);
    renderFileList();
    updateReviewPanel();
    showToast('Comment saved');
  }

  function cancelComment(filename, lineKey) {
    renderDiff(files[currentFileIdx]);
  }

  function editComment(filename, lineKey) {
    const key = filename + ':' + lineKey;
    const existingText = comments[key] || '';
    renderDiff(files[currentFileIdx]);

    // Insert edit box
    const rows = document.getElementById('diffBody').rows;
    for (let i = 0; i < rows.length; i++) {
      const td = rows[i].querySelector(`td[data-line="${lineKey}"]`);
      if (td) {
        const commentTr = document.createElement('tr');
        commentTr.className = 'comment-row';
        commentTr.innerHTML = `<td colspan="4">
          <div class="comment-box">
            <div class="comment-box-header"><span>Line ${lineKey}</span></div>
            <div class="comment-box-body">
              <textarea id="comment-input-${lineKey}" placeholder="Write a review comment...">${escapeHtml(existingText)}</textarea>
              <div class="comment-box-actions">
                <button class="btn" style="font-size:11px;padding:4px 10px;" onclick="cancelComment('${filename}', ${lineKey})">Cancel</button>
                <button class="btn btn-primary" style="font-size:11px;padding:4px 10px;" onclick="saveComment('${filename}', ${lineKey})">Save</button>
              </div>
            </div>
          </div>
        </td>`;

        // Find the comment row that follows and replace it, or insert after the line
        if (rows[i + 1] && rows[i + 1].classList.contains('comment-row')) {
          rows[i + 1].replaceWith(commentTr);
        } else {
          rows[i].after(commentTr);
        }
        setTimeout(() => commentTr.querySelector('textarea').focus(), 50);
        break;
      }
    }
  }

  function deleteComment(filename, lineKey) {
    delete comments[filename + ':' + lineKey];
    renderDiff(files[currentFileIdx]);
    renderFileList();
    updateReviewPanel();
  }

  // ─── File Review ───
  function reviewFile(status) {
    const f = files[currentFileIdx];
    if (fileReviews[f.name] === status) {
      delete fileReviews[f.name];
    } else {
      fileReviews[f.name] = status;
    }
    document.getElementById('approveFileBtn').classList.toggle('active', fileReviews[f.name] === 'approved');
    document.getElementById('rejectFileBtn').classList.toggle('active', fileReviews[f.name] === 'rejected');
    renderFileList();
    updateReviewPanel();

    // Auto-advance to next unreviewed file
    if (fileReviews[f.name] && currentFileIdx < files.length - 1) {
      const nextUnreviewed = files.findIndex((fi, i) => i > currentFileIdx && !fileReviews[fi.name]);
      if (nextUnreviewed !== -1) {
        setTimeout(() => selectFile(nextUnreviewed), 200);
      }
    }
  }

  // ─── View Mode ───
  function setViewMode(mode, btn) {
    viewMode = mode;
    document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    renderDiff(files[currentFileIdx]);
  }

  // ─── Review Panel ───
  function toggleReviewPanel() {
    const panel = document.getElementById('reviewPanel');
    panel.classList.toggle('visible');
    if (panel.classList.contains('visible')) updateReviewPanel();
  }

  function updateReviewPanel() {
    const body = document.getElementById('reviewPanelBody');
    const commentEntries = Object.entries(comments);
    const reviewEntries = Object.entries(fileReviews);

    if (commentEntries.length === 0 && reviewEntries.length === 0) {
      body.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No comments or reviews yet.</p>';
      return;
    }

    let html = '';

    // File reviews
    for (const [fname, status] of reviewEntries) {
      const icon = status === 'approved' ? '✓' : '✗';
      const color = status === 'approved' ? 'var(--accent-green)' : 'var(--accent-red)';
      html += `<div class="review-item">
        <div class="ri-file">${fname} <span style="color:${color};font-weight:600;">${icon} ${status}</span></div>
      </div>`;
    }

    // Comments
    for (const [key, text] of commentEntries) {
      const [fname, line] = key.split(':');
      html += `<div class="review-item">
        <div class="ri-file">${fname}</div>
        <div class="ri-line">Line ${line}</div>
        <div class="ri-comment">${escapeHtml(text)}</div>
      </div>`;
    }

    body.innerHTML = html;
  }

  // ─── Copy Review ───
  function copyReview(type) {
    let output = '';
    const summary = document.getElementById('summaryText').value.trim();
    const verdict = type === 'approve' ? 'APPROVED' : 'CHANGES REQUESTED';

    output += `## Review: ${verdict}\n\n`;

    if (summary) {
      output += `### Summary\n${summary}\n\n`;
    }

    // File verdicts
    const reviews = Object.entries(fileReviews);
    if (reviews.length > 0) {
      output += `### File Reviews\n`;
      for (const [fname, status] of reviews) {
        const icon = status === 'approved' ? '✅' : '❌';
        output += `- ${icon} \`${fname}\` — ${status}\n`;
      }
      output += '\n';
    }

    // Comments
    const commentEntries = Object.entries(comments);
    if (commentEntries.length > 0) {
      output += `### Inline Comments\n`;
      for (const [key, text] of commentEntries) {
        const [fname, line] = key.split(':');
        output += `\n**\`${fname}\`** (line ${line}):\n> ${text.replace(/\n/g, '\n> ')}\n`;
      }
    }

    navigator.clipboard.writeText(output).then(() => {
      showToast('Review copied to clipboard');
    });
  }

  // ─── Navigation ───
  function nextFile() {
    if (currentFileIdx < files.length - 1) selectFile(currentFileIdx + 1);
  }

  function prevFile() {
    if (currentFileIdx > 0) selectFile(currentFileIdx - 1);
  }

  // ─── Reset ───
  function resetAll() {
    files = [];
    currentFileIdx = 0;
    comments = {};
    fileReviews = {};
    document.getElementById('inputArea').classList.remove('hidden');
    document.getElementById('diffView').classList.remove('visible');
    document.getElementById('sidebar').style.display = 'none';
    document.getElementById('resetBtn').style.display = 'none';
    document.getElementById('reviewSummaryBtn').style.display = 'none';
    document.getElementById('reviewPanel').classList.remove('visible');
    document.getElementById('diffInput').value = '';
  }

  // ─── Sample Diff ───
  function loadSample() {
    document.getElementById('diffInput').value = `diff --git a/src/auth/login.ts b/src/auth/login.ts
index 8a3b5c1..f29e4d7 100644
--- a/src/auth/login.ts
+++ b/src/auth/login.ts
@@ -1,5 +1,6 @@
 import { auth } from '../firebase';
 import { signInWithEmailAndPassword } from 'firebase/auth';
+import { rateLimit } from '../middleware/rateLimit';

 export interface LoginResult {
   success: boolean;
@@ -12,10 +13,20 @@ export interface LoginResult {
  * Authenticate user with email and password
  */
 export async function login(email: string, password: string): Promise<LoginResult> {
+  // Rate limit: max 5 attempts per minute per IP
+  const allowed = await rateLimit('login', 5, 60);
+  if (!allowed) {
+    return {
+      success: false,
+      error: 'Too many login attempts. Please try again later.',
+    };
+  }
+
   try {
     const credential = await signInWithEmailAndPassword(auth, email, password);
     return {
       success: true,
+      lastLogin: new Date().toISOString(),
       user: {
         uid: credential.user.uid,
         email: credential.user.email,
@@ -23,7 +34,7 @@ export async function login(email: string, password: string): Promise<LoginResult
     };
   } catch (error: any) {
     return {
-      success: false,
+      success: false,
       error: mapFirebaseError(error.code),
     };
   }
diff --git a/src/middleware/rateLimit.ts b/src/middleware/rateLimit.ts
new file mode 100644
index 0000000..a1b2c3d
--- /dev/null
+++ b/src/middleware/rateLimit.ts
@@ -0,0 +1,32 @@
+const rateLimitStore = new Map<string, { count: number; resetAt: number }>();
+
+/**
+ * Simple in-memory rate limiter.
+ * For production, consider using Redis or a distributed store.
+ *
+ * @param key - Identifier for the rate limit bucket
+ * @param maxAttempts - Maximum attempts allowed within the window
+ * @param windowSeconds - Time window in seconds
+ * @returns true if the request is allowed
+ */
+export async function rateLimit(
+  key: string,
+  maxAttempts: number,
+  windowSeconds: number
+): Promise<boolean> {
+  const now = Date.now();
+  const entry = rateLimitStore.get(key);
+
+  if (!entry || now > entry.resetAt) {
+    rateLimitStore.set(key, { count: 1, resetAt: now + windowSeconds * 1000 });
+    return true;
+  }
+
+  if (entry.count >= maxAttempts) {
+    return false;
+  }
+
+  entry.count++;
+  return true;
+}
diff --git a/src/auth/login.test.ts b/src/auth/login.test.ts
index 1234567..abcdefg 100644
--- a/src/auth/login.test.ts
+++ b/src/auth/login.test.ts
@@ -1,6 +1,7 @@
 import { describe, it, expect, vi } from 'vitest';
 import { login } from './login';
 import { signInWithEmailAndPassword } from 'firebase/auth';
+import { rateLimit } from '../middleware/rateLimit';

 vi.mock('firebase/auth', () => ({
   auth: {},
@@ -8,6 +9,10 @@ vi.mock('firebase/auth', () => ({
   signInWithEmailAndPassword: vi.fn(),
 }));

+vi.mock('../middleware/rateLimit', () => ({
+  rateLimit: vi.fn().mockResolvedValue(true),
+}));
+
 describe('login', () => {
   it('should return success on valid credentials', async () => {
     const mockUser = { uid: '123', email: 'test@example.com' };
@@ -28,4 +33,13 @@ describe('login', () => {
     expect(result.success).toBe(false);
     expect(result.error).toBeDefined();
   });
+
+  it('should reject when rate limited', async () => {
+    vi.mocked(rateLimit).mockResolvedValueOnce(false);
+
+    const result = await login('test@example.com', 'password');
+
+    expect(result.success).toBe(false);
+    expect(result.error).toContain('Too many login attempts');
+  });
 });`;
    showToast('Sample diff loaded');
  }

  // ─── Keyboard Shortcuts ───
  document.addEventListener('keydown', (e) => {
    // Don't trigger in textareas
    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

    if (files.length === 0) return;

    switch (e.key) {
      case 'j': case ']': nextFile(); break;
      case 'k': case '[': prevFile(); break;
      case 'a': reviewFile('approved'); break;
      case 'x': reviewFile('rejected'); break;
      case 'v':
        viewMode = viewMode === 'unified' ? 'split' : 'unified';
        document.querySelectorAll('.view-toggle button').forEach((b, i) =>
          b.classList.toggle('active', (viewMode === 'unified' ? i === 0 : i === 1))
        );
        renderDiff(files[currentFileIdx]);
        break;
      case 'r': toggleReviewPanel(); break;
      case '?': showShortcuts(); break;
      case 'Escape':
        if (document.getElementById('shortcutsOverlay').classList.contains('visible')) {
          hideShortcuts();
        } else if (document.getElementById('reviewPanel').classList.contains('visible')) {
          toggleReviewPanel();
        }
        break;
    }
  });

  function showShortcuts() {
    document.getElementById('shortcutsOverlay').classList.add('visible');
  }

  function hideShortcuts() {
    document.getElementById('shortcutsOverlay').classList.remove('visible');
  }

  // ─── Utilities ───
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  }
</script>
</body>
</html>
