# GymIQ - Trainer Module - Full Specification

## Overview

Build a comprehensive trainer module that adds coach-trainee relationship management to GymIQ. Trainers create accounts for trainees, build weekly recurring training programs using the existing exercise library, monitor trainee progress, and communicate via one-directional messaging.

**Permission model:** Admin sees all > Trainer sees own trainees > Trainee sees self

---

## 1. DATA MODEL

### 1.1 Update `AppUser` interface

**File:** `src/lib/firebase/auth.ts` (line 15-25)

Add to existing AppUser:
```typescript
interface AppUser {
  // ... existing fields (uid, email, displayName, firstName, lastName, phoneNumber, role, timestamps) ...

  // Trainer-specific (when role === 'trainer')
  trainerProfile?: {
    specializations?: string[]  // ['strength', 'cardio', 'rehabilitation']
    bio?: string
    maxTrainees?: number        // default 50
  }

  // Trainee-specific (when linked to trainer)
  trainerId?: string            // UID of assigned trainer
  trainingGoals?: string[]      // ['muscle_gain', 'weight_loss', 'strength', 'endurance', 'flexibility', 'general_fitness']
  trainingNotes?: string        // Trainer's private notes about trainee
  injuriesOrLimitations?: string
}
```

### 1.2 `trainerRelationships/{id}` (already in Firestore rules)

```typescript
interface TrainerRelationship {
  id: string
  trainerId: string
  traineeId: string
  trainerName: string           // denormalized
  traineeName: string           // denormalized
  traineeEmail: string          // denormalized
  status: 'active' | 'paused' | 'ended'
  createdAt: Timestamp
  updatedAt: Timestamp
  endedAt?: Timestamp
  notes?: string
}
```

**Indexes:** `trainerId + status`, `traineeId + status`

### 1.3 `trainingPrograms/{id}` (NEW collection)

```typescript
interface TrainingProgram {
  id: string
  trainerId: string
  traineeId: string
  name: string                  // "program_name חיזוק"
  description?: string
  status: 'active' | 'paused' | 'completed' | 'draft'
  weeklyStructure: ProgramDay[] // array of training days
  durationWeeks?: number        // null = indefinite
  startDate: Timestamp
  endDate?: Timestamp
  currentWeek: number           // 1-based
  createdAt: Timestamp
  updatedAt: Timestamp
  notes?: string
}

interface ProgramDay {
  dayLabel: string              // "יום A", "יום B"
  dayOfWeek?: number            // 0=Sunday...6=Saturday (optional)
  name: string                  // "חזה + טרייספס"
  exercises: ProgramExercise[]
  restDay: boolean
  notes?: string
  estimatedDuration?: number    // minutes
}

interface ProgramExercise {
  exerciseId: string
  exerciseName: string          // denormalized
  exerciseNameHe: string        // denormalized
  imageUrl?: string             // denormalized
  category?: string             // denormalized
  primaryMuscle?: string        // denormalized
  equipment?: string            // denormalized
  order: number
  targetSets: number            // e.g., 3
  targetReps: string            // e.g., "8-12" (string for range)
  targetWeight?: number         // suggested starting weight (kg)
  restTime: number              // seconds, default 90
  notes?: string                // trainer notes for trainee
  supersetGroup?: string        // group ID for supersets
  reportType?: string           // from exercise definition
  assistanceTypes?: string[]    // from exercise definition
}
```

**Indexes:** `traineeId + status`, `trainerId + createdAt`

### 1.4 `trainerMessages/{id}` (NEW collection)

```typescript
interface TrainerMessage {
  id: string
  trainerId: string
  traineeId: string
  trainerName: string           // denormalized
  type: 'general' | 'workout_feedback' | 'program_update' | 'motivation' | 'instruction'
  subject?: string
  body: string
  referenceType?: 'workout' | 'exercise' | 'program'
  referenceId?: string
  referenceName?: string
  isRead: boolean               // default false
  readAt?: Timestamp
  createdAt: Timestamp
  priority: 'normal' | 'high'
}
```

**Indexes:** `traineeId + isRead + createdAt`, `traineeId + createdAt`, `trainerId + traineeId + createdAt`

### 1.5 Update `WorkoutHistoryEntry`

**File:** `src/domains/workouts/types/workout.types.ts`

Add to existing WorkoutHistoryEntry:
```typescript
// Add to existing source type:
source?: 'manual' | 'ai_trainer' | 'trainer_program'
programId?: string              // reference to trainingPrograms
programDayLabel?: string        // e.g., "יום A"
```

---

## 2. FIRESTORE SECURITY RULES

**File:** `firestore.rules`

### New rules to add:

```
// ============ TRAINING PROGRAMS ============
match /trainingPrograms/{programId} {
  allow read: if isAuthenticated() &&
    (resource.data.trainerId == request.auth.uid ||
     resource.data.traineeId == request.auth.uid ||
     isAdmin());

  allow create: if isTrainer() &&
    request.resource.data.trainerId == request.auth.uid;

  allow update: if isAuthenticated() &&
    (resource.data.trainerId == request.auth.uid || isAdmin());

  allow delete: if isAuthenticated() &&
    (resource.data.trainerId == request.auth.uid || isAdmin());
}

// ============ TRAINER MESSAGES ============
match /trainerMessages/{messageId} {
  allow read: if isAuthenticated() &&
    (resource.data.traineeId == request.auth.uid ||
     resource.data.trainerId == request.auth.uid ||
     isAdmin());

  allow create: if isTrainer() &&
    request.resource.data.trainerId == request.auth.uid;

  // Trainee can only update isRead/readAt
  allow update: if isAuthenticated() &&
    resource.data.traineeId == request.auth.uid &&
    request.resource.data.diff(resource.data).affectedKeys()
      .hasOnly(['isRead', 'readAt']);

  // Trainer can update their own messages
  allow update: if isAuthenticated() &&
    (resource.data.trainerId == request.auth.uid || isAdmin());

  allow delete: if isAuthenticated() &&
    (resource.data.trainerId == request.auth.uid || isAdmin());
}
```

### Updates to existing rules:

**`users` collection** - add trainer read:
```
// Add: Trainers can read user profiles (app filters to own trainees)
allow read: if isTrainer();
```

**`workoutHistory` collection** - add trainer read:
```
// Add: Trainers can read workout history (app filters to own trainees)
allow read: if isTrainer();
```

**`trainerRelationships`** - add admin access:
```
// Add: Admin can read/write all relationships
allow read, write: if isAdmin();
```

---

## 3. USER FLOWS

### 3.1 Trainer Onboarding
1. Admin goes to `/admin/users` (existing UsersList.tsx)
2. Changes user role to 'trainer' (existing functionality)
3. On trainer's next load, `useAuthStore` picks up new role
4. Navigation shows new "מאמן" link (trainer panel)
5. Dashboard shows new "Trainer" tile card

### 3.2 Trainee Registration (by trainer)
1. Trainer clicks "+ מתאמן חדש" on trainer dashboard
2. Modal form: firstName, lastName, email, phone, tempPassword, fitnessLevel, goals, notes, injuries
3. On submit:
   a. Create Firebase Auth via **secondary app instance** (avoids signing out trainer)
   b. Create `users/{newUid}` document with `trainerId` set
   c. Create `trainerRelationships` document
   d. Send password reset email (trainee sets own password)
   e. Sign out secondary auth instance
4. Toast: "המתאמן {name} נוצר בהצלחה"

**Critical:** Using secondary Firebase app instance (`initializeApp(config, 'secondary')`) prevents the `createUserWithEmailAndPassword` call from signing out the currently logged-in trainer.

### 3.3 Training Program Creation
1. Trainer selects trainee -> "צור תוכנית" or `/trainer/program/new`
2. **Step 1 - Details:** Program name, trainee select, duration, start date
3. **Step 2 - Week structure:** Add/remove days, name them, mark rest days
4. **Step 3 - Exercises per day:** Reuse ExerciseLibrary in selection mode. For each exercise: target sets, reps range, weight, rest time, notes
5. **Step 4 - Review:** Summary of full week. Save as draft or activate
6. Saving deactivates any previous active program for this trainee

### 3.4 Trainee Experience
1. Trainee logs in -> dashboard shows "תוכנית האימונים שלי" section (if has active program)
2. Sees today's planned workout from weekly structure
3. Taps "התחל אימון" -> exercises populate WorkoutBuilder store -> ActiveWorkout flow
4. On completion: `WorkoutHistoryEntry` saved with `source: 'trainer_program'`, `programId`, `programDayLabel`
5. Trainee can ALSO create own workouts independently (all existing features remain)
6. Inbox badge shows unread messages from trainer

### 3.5 Trainer Monitoring
1. Trainer dashboard shows trainee list with:
   - Name, last workout date, this-week count, completion rate, status indicator
2. Trainee detail page (`/trainer/trainee/:id`):
   - Profile: name, goals, notes, injuries
   - Current program overview
   - Performance stats: workout count, streak, volume, completion rate
   - Recent 10 workouts with expandable details
3. All data uses existing `getUserWorkoutStats` and `getUserWorkoutHistory` functions

### 3.6 Messaging
1. Trainer composes from `/trainer/messages` or trainee detail page
2. Fields: trainee select, type, subject, body, priority, optional workout reference
3. Creates `trainerMessages` document
4. Trainee sees badge count (polled every 60s)
5. Inbox at `/inbox`: message list, tap to read, mark as read

---

## 4. FILE STRUCTURE

```
src/domains/trainer/
  types/
    trainer.types.ts              -- All interfaces (TrainerRelationship, TrainingProgram, etc.)
    index.ts
  services/
    trainerService.ts             -- Relationship CRUD + trainee stats
    traineeAccountService.ts      -- Create trainee accounts (secondary auth)
    programService.ts             -- Program CRUD + day-to-workout conversion
    messageService.ts             -- Message CRUD + unread count
  store/
    trainerStore.ts               -- Zustand: trainees list, selected trainee
    messageStore.ts               -- Zustand: unread count, messages
  hooks/
    useTrainerData.ts             -- Load trainer's trainees with stats
    useTraineeProgram.ts          -- Load trainee's active program
    useTrainerMessages.ts         -- Message operations
    useUnreadMessages.ts          -- Poll unread count (60s interval)
  components/
    TrainerLayout.tsx             -- Layout wrapper with trainer sidebar
    TrainerDashboard.tsx          -- Trainee list with stats
    TraineeCard.tsx               -- Card in trainee list
    TraineeDetail.tsx             -- Full trainee view
    TraineeRegistrationModal.tsx  -- Create trainee form
    TraineeProfileSection.tsx     -- Profile section in detail view
    TraineePerformance.tsx        -- Stats section
    TraineeRecentWorkouts.tsx     -- Workout history section
    TrainerDashboardTile.tsx      -- Tile for UserDashboard
    ProgramBuilder/
      ProgramBuilder.tsx          -- Multi-step wizard
      ProgramDayEditor.tsx        -- Single day editor
      ProgramExerciseEditor.tsx   -- Exercise config within day
      ProgramReview.tsx           -- Review before save
      ProgramDayCard.tsx          -- Day summary card
    ProgramView/
      TraineeProgramView.tsx      -- Trainee dashboard program section
      ProgramDayDetail.tsx        -- Day detail view
      ProgramExerciseCard.tsx     -- Exercise in program view
    Messages/
      MessageCenter.tsx           -- Trainer message center
      MessageComposer.tsx         -- Compose message
      MessageList.tsx             -- Message list
      MessageCard.tsx             -- Individual message
    TraineeInbox/
      TraineeInbox.tsx            -- Trainee inbox page
      InboxMessageCard.tsx        -- Message in inbox
      InboxBadge.tsx              -- Unread count badge
```

---

## 5. ROUTING

**File:** `src/App.tsx`

### New routes:

```
/trainer                        -- TrainerDashboard (AuthGuard requiredRole="trainer")
/trainer/trainee/:id            -- TraineeDetail
/trainer/trainee/:id/messages   -- Messages to specific trainee
/trainer/programs               -- Programs list
/trainer/program/new            -- ProgramBuilder (create)
/trainer/program/:id/edit       -- ProgramBuilder (edit)
/trainer/messages               -- MessageCenter
/inbox                          -- TraineeInbox (under user routes, AuthGuard)
```

### AuthGuard update needed:

**File:** `src/app/router/guards/AuthGuard.tsx` (line 19-26)

Current logic only allows admin to bypass role check. Need role hierarchy:
```typescript
// Replace exact role match with hierarchy:
const roleHierarchy = { user: 0, trainer: 1, admin: 2 }
const userLevel = roleHierarchy[user?.role || 'user']
const requiredLevel = roleHierarchy[requiredRole]
if (userLevel < requiredLevel) return <Navigate to="/dashboard" />
```

### Navigation updates:

**File:** `src/design-system/layouts/MainLayout.tsx`

- Add trainer link (after admin link pattern, line 148-167):
  ```
  {(isTrainer || isAdmin) && <NavLink to="/trainer">מאמן</NavLink>}
  ```
- Add inbox link for trainees:
  ```
  {user?.trainerId && <NavLink to="/inbox">הודעות <InboxBadge /></NavLink>}
  ```

### Dashboard updates:

**File:** `src/domains/dashboard/components/UserDashboard.tsx`

- Add `TrainerDashboardTile` for trainer/admin roles
- Add `TraineeProgramView` for users with trainerId

---

## 6. IMPLEMENTATION PHASES

### Phase 1: Foundation (Types + Rules)
**Creates:**
- `src/domains/trainer/types/trainer.types.ts`
- `src/domains/trainer/types/index.ts`

**Modifies:**
- `firestore.rules` - add trainingPrograms, trainerMessages rules, update users/workoutHistory
- `src/lib/firebase/auth.ts` - extend AppUser interface
- `src/domains/workouts/types/workout.types.ts` - add trainer_program source

**Dependencies:** None

### Phase 2: Trainer-Trainee Relationships + Registration
**Creates:**
- `src/domains/trainer/services/trainerService.ts`
- `src/domains/trainer/services/traineeAccountService.ts`
- `src/domains/trainer/store/trainerStore.ts`
- `src/domains/trainer/hooks/useTrainerData.ts`
- `src/domains/trainer/components/TrainerLayout.tsx`
- `src/domains/trainer/components/TrainerDashboard.tsx`
- `src/domains/trainer/components/TraineeCard.tsx`
- `src/domains/trainer/components/TraineeRegistrationModal.tsx`

**Modifies:**
- `src/App.tsx` - add /trainer routes
- `src/app/router/guards/AuthGuard.tsx` - role hierarchy
- `src/design-system/layouts/MainLayout.tsx` - trainer nav link

**Dependencies:** Phase 1

**Testing:** Create trainer via admin > register trainee > verify login with reset password > verify list

### Phase 3: Training Program Builder
**Creates:**
- `src/domains/trainer/services/programService.ts`
- All `ProgramBuilder/` components (5 files)

**Modifies:**
- `src/App.tsx` - add program routes
- ExerciseLibrary may need `selectionMode` prop or extract shared `ExerciseSelector`

**Dependencies:** Phase 2

**Testing:** Create program > assign exercises > save > verify in Firestore > edit > deactivate old

### Phase 4: Trainee Program Experience
**Creates:**
- `src/domains/trainer/hooks/useTraineeProgram.ts`
- All `ProgramView/` components (3 files)

**Modifies:**
- `src/domains/dashboard/components/UserDashboard.tsx` - add program section
- `src/domains/workouts/store/workoutBuilderStore.ts` - add `loadFromProgram` action
- `src/lib/firebase/workoutHistory.ts` - handle trainer_program source

**Dependencies:** Phase 3

**Testing:** Login as trainee > see program > start workout > complete > verify history has programId

### Phase 5: Trainer Monitoring Dashboard
**Creates:**
- `src/domains/trainer/components/TraineeDetail.tsx`
- `src/domains/trainer/components/TraineeProfileSection.tsx`
- `src/domains/trainer/components/TraineePerformance.tsx`
- `src/domains/trainer/components/TraineeRecentWorkouts.tsx`
- `src/domains/trainer/components/TrainerDashboardTile.tsx`

**Modifies:**
- `src/domains/dashboard/components/UserDashboard.tsx` - add TrainerDashboardTile
- `src/App.tsx` - add trainee detail route

**Dependencies:** Phases 2, 4

**Testing:** View trainee detail > verify stats > check workout history > test empty states

### Phase 6: Messaging System
**Creates:**
- `src/domains/trainer/services/messageService.ts`
- `src/domains/trainer/store/messageStore.ts`
- `src/domains/trainer/hooks/useTrainerMessages.ts`
- `src/domains/trainer/hooks/useUnreadMessages.ts`
- All `Messages/` components (4 files)
- All `TraineeInbox/` components (3 files)

**Modifies:**
- `src/App.tsx` - add message routes + /inbox
- `src/design-system/layouts/MainLayout.tsx` - add inbox link with badge

**Dependencies:** Phase 2

**Testing:** Send message > check trainee inbox > mark read > verify badge count

### Phase 7: Integration + Polish
**Modifies:**
- Final UI polish across all trainer components
- Mobile responsiveness validation (375px)
- RTL validation
- Inline styles check (`grep -r "style={{" src/domains/trainer/`)
- Security check (`grep -r "AIza" src/domains/trainer/`)
- End-to-end flow test

**Dependencies:** All phases

---

## 7. KEY ARCHITECTURAL DECISIONS

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Trainee account creation | Secondary Firebase app instance | Prevents signing out trainer. No Cloud Function needed |
| Trainer read access to trainee data | Application-level filtering with broad `isTrainer()` rule | Simpler rules. Acceptable security for app scale |
| Message delivery | Polling (60s interval) | Simpler than realtime listeners. Messages aren't time-critical |
| Program structure | Array within document (not subcollections) | Max ~42KB for 7 days x 12 exercises. Well under 1MB limit. Atomic updates |
| Exercise data in programs | Denormalized (name, image, muscle stored in program) | Fewer reads, offline-capable, follows existing WorkoutHistoryEntry pattern |
| ExerciseLibrary reuse | Add `selectionMode` prop or extract shared component | Reuse existing filter/search UI without affecting workoutBuilderStore |

---

## 8. CRITICAL FILES TO MODIFY

| File | Change |
|------|--------|
| `firestore.rules` | Add trainingPrograms, trainerMessages rules; update users, workoutHistory for trainer read |
| `src/lib/firebase/auth.ts:15-25` | Extend AppUser interface with trainer/trainee fields |
| `src/domains/workouts/types/workout.types.ts` | Add `trainer_program` source, programId, programDayLabel |
| `src/App.tsx` | Add all /trainer/* routes + /inbox route |
| `src/app/router/guards/AuthGuard.tsx:19-26` | Role hierarchy instead of exact match |
| `src/design-system/layouts/MainLayout.tsx:38,148-167` | Add trainer + inbox nav links |
| `src/domains/dashboard/components/UserDashboard.tsx` | Add TrainerDashboardTile + TraineeProgramView |
| `src/domains/workouts/store/workoutBuilderStore.ts` | Add `loadFromProgram` action |
| `src/lib/firebase/workoutHistory.ts` | Handle trainer_program source in save functions |

---

## 9. VERIFICATION PLAN

After full implementation:
1. **Admin flow:** Promote user to trainer -> verify trainer dashboard appears
2. **Registration flow:** Trainer creates trainee -> trainee receives email -> trainee logs in
3. **Program flow:** Trainer builds weekly program -> assigns to trainee -> trainee sees on dashboard
4. **Workout flow:** Trainee starts trainer workout -> completes -> history shows programId
5. **Monitoring flow:** Trainer sees trainee stats, workouts, completion rate
6. **Message flow:** Trainer sends message -> trainee sees badge -> opens inbox -> marks read
7. **Permission check:** Trainee cannot access /trainer routes, trainer cannot see other trainer's trainees
8. **Mobile check:** All screens at 375px width
9. **Style check:** Zero inline styles in trainer domain (`grep -r "style={{" src/domains/trainer/`)
10. **Security check:** No API keys exposed
